(define lastTime (time-seconds))
(define elapsedTime 0)

(define movement-speed 0.1)
(define movement-speed-air 0.1)
(define (set-movement-speed speed speed-air)
  (set! movement-speed speed)
  (set! movement-speed-air speed-air)
  (format #t "traits: setting speed: ~a, air: ~a\n" speed speed-air)
)
(define jump-height 10)
(define (set-jump-height height)
  (set! jump-height height)
  (format #t "traits: setting jump height: ~a\n" height)
)

(define (set-object-values gravity restitution friction)
  (format #t "traits: set gravity ~a\n" gravity)
  (format #t "traits: set restitution ~a\n" restitution)
  (format #t "traits: set friction ~a\n" friction)

  (gameobj-setattr! 
    mainobj
    (list
      (list "physics_gravity"     (list 0 gravity 0))
      (list "physics_restitution" restitution)
      (list "physics_friction"    friction)
    )
  )
)

(define xsensitivity 1)
(define ysensitivity 1)
(define (set-sensitivity xvalue yvalue)
  (set! xsensitivity xvalue)
  (set! ysensitivity yvalue)
  (format #t "traits: setting xsensitivity: ~a, ysensitivity: ~a\n" xsensitivity ysensitivity)
)

(define configIndex 0)
(define (nextConfigIndex) (set! configIndex (+ configIndex 1)))
(define (prevConfigIndex) (set! configIndex (max 0 (- configIndex 1))))
(define (update-config)
  (define traits (sql (sql-compile "select speed, speed-air, jump-height, gravity, restitution, friction from traits")))
  (define settings (list-ref (sql (sql-compile "select xsensitivity, ysensitivity from settings")) 0))
  (if (= (length traits) 0)
    (display "no traits in config\n")
    (if (>= configIndex (length traits))
      (set! configIndex (max 0 (- (length traits) 1)))
      (let ((targettrait (list-ref traits configIndex)))
        (format #t "Settings config to index: ~a\n" configIndex)
        (set-movement-speed (string->number (list-ref targettrait 0)) (string->number (list-ref targettrait 1)))
        (set-jump-height (string->number (list-ref targettrait 2)))
        (set-object-values 
          (string->number (list-ref targettrait 3))
          (string->number (list-ref targettrait 4))
          (string->number (list-ref targettrait 5))
        )
      )
    )
  )
  (set-sensitivity (string->number (car settings)) (string->number (cadr settings)))  
)

(define is-grounded #f)
(define grounded-id #f)
(define (onCollideEnter obj hitpoint normal) 
  (define ycomponent (cadr normal))
  (if (< ycomponent 0)
    (begin
      (set! is-grounded #t)
      (set! grounded-id (gameobj-id obj))
    )
  )
)
(define (onCollideExit obj)
  (format #t "onCollideExit ~a" obj)
  (if (equal? (gameobj-id obj) grounded-id)
    (begin
      (set! is-grounded #f)
      (set! grounded-id #f)
    )
  )
)

(define (jump)
  (define impulse (list 0 (* jump-height elapsedTime 1000) 0))
  (format #t "impulse is: ~a\n" impulse)
  (if is-grounded
    (applyimpulse mainobj impulse)
  )
)

(define look-velocity-x 0)
(define look-velocity-y 0)
(define (look) 
  (define lookdelta (list (* look-velocity-x xsensitivity elapsedTime) (* -1 look-velocity-y ysensitivity elapsedTime) 0))
  (gameobj-setrotd! mainobj (car lookdelta) (cadr lookdelta) (caddr lookdelta))
  (reset-look-velocity)
)
(define (reset-look-velocity) 
  (set! look-velocity-x 0)
  (set! look-velocity-y 0)
)
(define (onMouseMove x y)
  (set! look-velocity-x x)
  (set! look-velocity-y y)
)

(define (onKey key scancode action mods) 
  (if (= key 87)
    (begin 
      (if (= action 1) (set! go-forward #t))
      (if (= action 0) (set! go-forward #f))
    )
  )
  (if (= key 65)
    (begin
      (if (= action 1) (set! go-left #t))
      (if (= action 0) (set! go-left #f))
    )
  )
  (if (= key 83)
    (begin
      (if (= action 1) (set! go-backward #t))
      (if (= action 0) (set! go-backward #f))
    )
  )
  (if (= key 68)
    (begin
      (if (= action 1) (set! go-right #t))
      (if (= action 0) (set! go-right #f))
    )
  )
  (if (and (= key 264) (= action 1)) (nextConfigIndex)) ; down arrow
  (if (and (= key 265) (= action 1)) (prevConfigIndex)) ; up arrow
  (if (and (= key 345) (= action 1)) (update-config))   ; right ctrl
  (if (and (= key 32) (= action 1)) (jump)) ; space
)

(define (move x y z) 
  (applyimpulse-rel mainobj (list x y z))
)

(define go-forward #f)
(define go-left #f)
(define go-backward #f)
(define go-right #f)
(define (onFrame)
  (define currTime (time-seconds))
  (set! elapsedTime (- currTime lastTime))
  (set! lastTime currTime)
  (if (equal? go-forward  #t) (move 0 0 (* -1 movement-speed)))
  (if (equal? go-left     #t) (move (* -0.8 movement-speed) 0 0))
  (if (equal? go-right    #t) (move (* 0.8 movement-speed) 0 0))
  (if (equal? go-backward #t) (move 0 0 movement-speed))
  (look)
)

(update-config)